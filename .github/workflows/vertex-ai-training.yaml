name: Train Model on Vertex AI

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types: [completed]
    branches: [Automation, main]
  workflow_dispatch: # Manual trigger

env:
  REGISTRY: europe-west1-docker.pkg.dev
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REPOSITORY: mlops-images
  IMAGE_NAME: train
  REGION: europe-west1

jobs:
  submit-training-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Determine Branch Name
        id: get_branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Detected workflow_run trigger."
            echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          else
            echo "Detected manual trigger."
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Check upstream workflow status
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "Upstream Docker Build failed! Stopping training."
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_branch.outputs.branch }}

      - name: Sanitize Project ID
        run: |
          CLEAN_ID=$(echo "${{ secrets.GCP_PROJECT_ID }}" | tr -d '\n' | tr -d '\r' | xargs)
          echo "PROJECT_ID=$CLEAN_ID" >> $GITHUB_ENV

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Submit Vertex AI Custom Training Job
        id: submit_job
        run: |
          TARGET_BRANCH="${{ steps.get_branch.outputs.branch }}"
          IMAGE_URI="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${TARGET_BRANCH}"
          
          # Create unique ID and Output Path to prevent overwriting previous models
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          JOB_NAME="train-${TARGET_BRANCH}-${TIMESTAMP}"
          JOB_OUTPUT_DIR="gs://mlops-models-${{ env.PROJECT_ID }}/training-output/${JOB_NAME}"

          # Export this variable so the next step can download from here
          echo "JOB_OUTPUT_DIR=$JOB_OUTPUT_DIR" >> $GITHUB_ENV
          
          echo "Preparing job for image: $IMAGE_URI"

          cat > config.yaml <<EOF
          baseOutputDirectory:
            outputUriPrefix: $JOB_OUTPUT_DIR
          workerPoolSpecs:
            - machineSpec:
                machineType: n1-standard-4
                acceleratorType: NVIDIA_TESLA_T4
                acceleratorCount: 1
              replicaCount: 1
              containerSpec:
                imageUri: $IMAGE_URI
                env:
                  - name: WANDB_API_KEY
                    value: ${{ secrets.WANDB_API_KEY }}
                  - name: GCS_DATA_PATH
                    value: gs://mlops-data-profound-nuance-438223-i0/processed
                args: []
          EOF

          JOB_RESPONSE=$(gcloud ai custom-jobs create \
            --display-name="$JOB_NAME" \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --config=config.yaml \
            --format="value(name)")
          
          # Extract Job ID correctly
          JOB_ID=$(echo $JOB_RESPONSE | cut -d'/' -f6)
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Submitted training job: $JOB_ID"

      - name: Print Job Submission Status
        run: |
          echo "Training job submitted successfully!"
          echo "Monitor progress at: https://console.cloud.google.com/vertex-ai/training/custom-jobs?project=${{ env.PROJECT_ID }}"

      - name: Upload trained model to Artifact Registry
        if: steps.submit_job.outcome == 'success'
        run: |
          JOB_ID="${{ steps.submit_job.outputs.job_id }}"
          echo "Waiting for training job $JOB_ID to complete..."
          
          # 1. Wait Loop
          MAX_WAIT=7200
          ELAPSED=0
          WAIT_INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            JOB_STATE=$(gcloud ai custom-jobs describe $JOB_ID \
              --project=${{ env.PROJECT_ID }} \
              --region=${{ env.REGION }} \
              --format="value(state)")
            
            if [ "$JOB_STATE" == "JOB_STATE_SUCCEEDED" ]; then
              echo "Training job completed successfully!"
              break
            elif [ "$JOB_STATE" == "JOB_STATE_FAILED" ] || [ "$JOB_STATE" == "JOB_STATE_CANCELLED" ]; then
              echo "Training job failed!"
              exit 1
            fi
            sleep $WAIT_INTERVAL
            ELAPSED=$((ELAPSED + WAIT_INTERVAL))
          done
          
          # 2. Prepare Artifacts
          mkdir -p model-package
          
          echo "Downloading output from: ${{ env.JOB_OUTPUT_DIR }}"
          gsutil -m cp -r "${{ env.JOB_OUTPUT_DIR }}/*" model-package/
          
          # --- FIXED LOGIC START ---
          CKPT_FILE=$(find model-package -name "best_model*.ckpt" | head -n 1)
          
          if [ -n "$CKPT_FILE" ]; then
            echo "Found checkpoint: $CKPT_FILE"
            # FIX 1: Stricter Regex. Only capture 'digits.digits'
            # This ignores the trailing '.' from .ckpt
            ACCURACY=$(echo "$CKPT_FILE" | grep -oP 'val_acc=\K\d+\.\d+')
          else
            ACCURACY="unknown"
          fi
          
          if [ -z "$ACCURACY" ]; then
             ACCURACY="unknown"
          fi
          
          echo "Detected Model Accuracy: $ACCURACY"

          # Create metadata
          cat > model-package/metadata.json <<EOF
          {
            "name": "eye-diseases-model",
            "accuracy": "$ACCURACY",
            "job_id": "$JOB_ID",
            "commit": "${{ github.sha }}",
            "branch": "${{ steps.get_branch.outputs.branch }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          tar -czf model.tar.gz -C model-package .

          echo "Uploading to Artifact Registry..."
          
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Construct raw version string
          RAW_VERSION="${{ steps.get_branch.outputs.branch }}-${SHORT_SHA}-acc${ACCURACY}"
          
          # FIX 2: Sanitize Version ID
          # 1. Convert to LOWERCASE (Fixes 'Automation' -> 'automation')
          # 2. Replace invalid chars with '.'
          # 3. Strip leading/trailing dots/dashes
          VERSION=$(echo "$RAW_VERSION" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/./g' | sed 's/^[.-]*//;s/[.-]*$//')

          gcloud artifacts generic upload \
            --package="eye-diseases-model" \
            --version="$VERSION" \
            --source="model.tar.gz" \
            --repository="mlops-models" \
            --location="${{ env.REGION }}" \
            --project="${{ env.PROJECT_ID }}"

          echo "Upload complete! Version: $VERSION"